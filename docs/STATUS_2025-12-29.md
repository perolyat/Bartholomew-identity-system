# Status – 2025-12-29 (Updated 2026-01-20 17:25 AEST)

## Current Baseline

- **Stage 0 kernel (safety, parking brake, WAL, dreaming loops)**
  - As per `STAGE_0_COMPLETION.md`, the experience kernel is implemented and exercised by the Stage‑0 tests (kernel lifecycle, nudge pipeline, reflections, WAL checkpointing). Those tests are still green on this run; the kernel starts, logs water, generates nudges, writes daily/weekly reflections, and shuts down cleanly.

- **Memory rules, redaction, consent gates, encryption, summarization (Phase 2A–2C)**
  - Governance rules are wired via `memory_rules._rules_engine` and enforced inside `MemoryStore.upsert_memory` (privacy markers, allow_store decisions, summary / fts_index_mode flags, etc.).
  - Redaction and encryption engines are integrated, and tests exercise both, but a few Phase‑2B/2C integration cases are currently failing on this machine (see Open Items).

- **Embeddings + vector store (Phase 2D)** ✅ FULLY WORKING (2026-01-20)
  - `EmbeddingEngine` is present with a deterministic fallback when `sentence-transformers` is not installed.
  - `VectorStore` is wired to the same SQLite DB as the kernel and exposes upsert/count operations used by retrieval.
  - The embedding lifecycle (compute‑only, persist after consent, re‑embed, foreign‑key cascade) is implemented and all 25 tests pass.
  - **Fix applied:** Moved VectorStore initialization and embedding persistence outside the async context in `memory_store.py` to avoid database locking issues on Windows.

- **FTS + hybrid retrieval**
  - FTS client (`fts_client.FTSClient`) and FTS schema hygiene/migration helpers exist, with BM25 UDF + matchinfo('pcx') fallback logic.
  - `HybridRetriever` / fusion math / recency shaping / RRF / tiebreakers are implemented and heavily exercised by unit + integration tests.
  - On this Windows + SQLite build, FTS5 and `matchinfo` support are limited; many FTS / hybrid tests are currently red due to missing FTS5/matchinfo and Windows file locking (see Open Items), but the high‑level design matches the doc set (`FTS_INGESTION_WIRING_IMPLEMENTATION.md`, `FTS_SCHEMA_HYGIENE_IMPLEMENTATION.md`, `FTS5_FALLBACK_IMPLEMENTATION.md`, hybrid_* tests).

- **Chunking**
  - `bartholomew/kernel/chunking_engine.py` exists in the working tree as a new untracked file.
  - It is not yet wired into ingestion (no chunk metadata written on upsert) or retrieval (no chunk‑level scoring or policies); there are no chunking tests yet. Stage‑2f chunking is still design‑only at this point.

## Open Items

- **Stage‑2f chunking design & implementation**
  - Finalize chunking model (chunk IDs, boundaries, size policy, kind‑specific shapes).
  - Wire `chunking_engine` into the ingestion path so `MemoryStore.upsert_memory` produces chunk records alongside base memories.
  - Expose chunk metadata to FTS/vector stores and hybrid retriever (scoring, boosts, snippet assembly).
  - Add metrics around chunk counts/sizes and ensure WAL / retention rules play nicely with chunks.

- **Non‑environmental test failures (this run)**
  - **Summarization / truncation** ✅ FIXED (2026-01-20)
    - `tests/test_phase2c_summarization.py::TestSummarizationEngine::test_summarize_fallback_truncation` – **NOW PASSING**. The `_truncate_fallback()` method correctly truncates content to target length + ellipsis.
  - **Encryption + summarization integration**
    - `tests/test_phase2c_summarization.py::TestMemoryStoreIntegration::test_summary_encrypted_with_value` – summary and value are stored as encrypted envelopes, but `EncryptionEngine.try_decrypt_if_envelope` does not round‑trip back to the original plaintext under the configured key.
  - **Embeddings + vector store lifecycle** ✅ FIXED (2026-01-20)
    - All embedding lifecycle tests now pass after refactoring `memory_store.py` to move VectorStore initialization and embedding persistence OUTSIDE the async context. This fixes database locking issues on Windows where synchronous sqlite3 operations were conflicting with open aiosqlite connections.
    - `tests/test_phase2d_compute_only.py` – **3/3 PASSING** (compute-only, two sources, persist after consent)
    - `tests/test_phase2d_embeddings.py` – **17/17 PASSING** (all embedding integration tests)
    - `tests/test_phase2d_fixpack_v3.py` – **5/5 PASSING** (summary fallback, boost, policy flags)
  - **Retrieval policy / boosts / flags** ✅ FIXED (2026-01-20)
    - Fixed as part of embedding lifecycle refactor above.
  - Privacy gates fixed; `test_privacy_gates_upheld` is red only due to a Windows SQLite temp DB `PermissionError` during teardown.
  - **Retrieval mode / configuration** ✅ FIXED (2026-01-20)
    - `tests/test_retrieval_factory.py::test_explicit_mode_overrides_env_and_config`, `::test_fts_mode_explicit` – **NOW PASSING**. Explicit `mode="fts"` correctly returns `FTSOnlyRetriever` without degradation.
  - **Metrics registry idempotency**
    - `tests/test_metrics_registry_guard.py::test_metrics_route_idempotent_init` – importing the metrics route multiple times re‑registers the same Prometheus counters and hits `Duplicated timeseries in CollectorRegistry`, so `_init_metrics_once` is not fully idempotent under the default global registry.

- **Environment‑ / tooling‑driven issues on this machine** (Partially Fixed 2026-01-20)
  - **Pytest configuration** ✅ FIXED (2026-01-20)
    - Added `pytest-asyncio` and `pytest-mock` to `requirements-dev.txt`
    - Configured `asyncio_mode = "auto"` in `pyproject.toml` for proper async test handling
    - Added `unit` marker to eliminate unknown marker warnings
    - Fixed UTF-8 encoding issues in YAML file reading tests (`test_phase2a_redaction.py`, `test_phase2c_summarization.py`)
  - **SQLite / FTS / bm25 / matchinfo**
    - Most FTS + hybrid integration tests (e.g. `test_fts_basic_search`, rare‑token tests, recency flip integration, bm25 fallback tests, RRF tests) are failing with:
      - `sqlite3.OperationalError: unable to use function matchinfo in the requested context`
      - `sqlite3.DatabaseError: database disk image is malformed` on ephemeral test DBs
      - And extensive `fts5: syntax error` logs.
    - This strongly suggests the Python 3.13 + Windows SQLite build here does not fully support FTS5 / matchinfo the way the tests expect; upstream CI on Linux/macOS likely exercises a different SQLite build where these pass.
  - **Windows file‑locking semantics**
    - A large number of tests that use `tempfile.TemporaryDirectory()` around SQLite DBs fail cleanup with `PermissionError: [WinError 32] ... being used by another process`.
    - This points to SQLite connections not being fully closed before tempdir cleanup; it is exposed here because Windows keeps stricter locks than POSIX. The patterns appear across:
      - FTS tests, hybrid fusion/recency/RRF tests, tiebreakers, and several integration benchmarks.
  - **Pytest plugins / fixtures / async handling**
    - `tests/test_retrieval_factory.py::test_vector_adapter_delegates_to_query` – `fixture 'mocker' not found` → `pytest-mock` plugin is not installed/enabled in this environment.
    - `tests/test_consent_gates.py::*` – async fixture `memory_store` is being treated as a plain coroutine (`AttributeError: 'coroutine' object has no attribute 'upsert_memory'`) plus deprecation warnings from `pytest_asyncio`. This looks like a pytest / pytest‑asyncio configuration mismatch rather than a core logic bug.
    - Tests that touch `privacy_guard.request_permission_to_store` fail under pytest’s stdin capture (`pytest: reading from stdin while output is captured!`). In CI these likely run with a patched input or a different capture mode.
  - **API bridge import path**
    - Metrics production‑mode tests (`tests/test_metrics_production_mode.py::*`) currently error with `ImportError: attempted relative import with no known parent package` when doing `from app import app` from the project root. The local test invocation here doesn’t mirror the package layout the tests expect (running the API bridge as a package).

All of the above are a snapshot for 2025‑12‑29 on this specific Windows dev environment; upstream CI status should be treated as the source of truth for cross‑platform health.
